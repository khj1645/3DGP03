## DirectX 12 프로젝트 그림자 구현 과정 요약

### 초기 상태
프로젝트에 그림자 관련 리소스(그림자 맵, 관련 셰이더 등)와 기본 렌더링 로직은 대부분 구현되어 있었으나, 실제 화면에는 그림자가 전혀 표시되지 않는 상태에서 분석을 시작했습니다.

### 1. 런타임 충돌 오류 해결
- **문제:** 프로그램을 디버그 모드로 실행 시, `RootParameterIndex [1] is out of bounds` 라는 D3D12 오류가 발생하며 비정상 종료되었습니다.
- **원인:** UI를 그릴 때 사용되는 단순한 루트 시그니처(파라미터 1개)가 다음 프레임까지 유지되어, 그림자 패스에서 더 많은 파라미터를 필요로 하는 메인 루트 시그니처와 충돌하는 것이 원인이었습니다.
- **해결:** `CMaterial::UpdateShaderVariables` 함수를 수정하여, 현재 활성화된 셰이더가 UI 셰이더일 경우 재질의 상수 정보(루트 파라미터 1번 사용)를 업데이트하지 않도록 예외 처리하여 충돌을 해결했습니다.

### 2. 리소스 배리어 상태 오류 해결
- **문제:** `Scene Texture`의 리소스 상태가 예상과 달라 발생하는 `RESOURCE_BARRIER_BEFORE_AFTER_MISMATCH` 오류가 발생했습니다.
- **원인:** 텍스처가 `PIXEL_SHADER_RESOURCE` 상태로 생성되었으나, 렌더링 루프는 `COMMON` 상태를 예상하고 상태 전이를 시작하여 첫 프레임에서 불일치가 발생했습니다.
- **해결:** `GameFramework::CreateSceneTexture` 함수에서 해당 텍스처의 초기 상태를 `COMMON`으로 변경하여 문제를 해결했습니다.

### 3. 핵심 문제: 그림자 미표시 현상 해결
#### 3.1. 그림자 생성(Casting) 문제
- **현상:** 플레이어를 포함한 모든 객체의 그림자가 생성되지 않았습니다. 셰이더 디버깅 결과, 그림자 값이 항상 1.0(그림자 없음)으로 계산되었습니다.
- **원인 1: 절두체 컬링 (Frustum Culling):** 빛의 시점에서 그림자 맵을 그릴 때, 헬리콥터 등의 객체들이 빛의 시야 범위(절두체) 밖에 있다고 판단되어 렌더링에서 제외(컬링)되고 있었습니다.
- **해결 1:** 빛의 직교 투영 절두체 크기(`shadowMapWidth`)를 2000에서 8000으로 대폭 늘려, 모든 객체가 빛의 시야에 포함되도록 하여 컬링 문제를 해결했습니다.

- **원인 2: 객체 계층 구조 렌더링 누락:** 플레이어 그림자는 건물에 나타났지만, 다른 헬리콥터 그림자는 나타나지 않았습니다. 이는 플레이어 객체와 달리, 다른 헬리콥터 객체들은 실제 모델 메쉬를 '자식 객체'로 가지고 있는 계층 구조였기 때문입니다. 기존 `RenderShadowMap`의 렌더링 코드는 이 자식 객체를 그리지 않고 부모 객체의 빈 메쉬만 그리려 시도하여 그림자가 생성되지 않았습니다.
- **해결 2:**
    1. 객체의 계층 구조(자식/형제)를 재귀적으로 순회하며 모든 메쉬를 그리는 `CGameObject::RenderShadow` 함수를 새로 구현했습니다.
    2. 그림자 패스에서 객체를 그릴 때, `UpdateTransform(NULL)` 함수를 호출하여 자식 객체의 최종 월드 위치를 갱신한 후 `RenderShadow` 함수를 호출하도록 수정하여, 모든 객체가 올바른 위치에 그려지도록 했습니다.

#### 3.2. 그림자 수신(Receiving) 문제
- **현상:** 플레이어와 건물의 그림자가 건물 표면에는 나타났지만, 지형 위에는 나타나지 않았습니다.
- **원인:** 디버깅용 색상(자홍색)으로 확인 결과, 지형 셰이더(`PSTerrain`)는 그림자 정보를 정상적으로 받고 있었으나, 그림자 진 부분의 색상(ambient)이 원래 지형 색과 큰 차이가 없어 눈에 보이지 않았던 것입니다.
- **해결:** `PSTerrain` 셰이더에서 그림자가 적용될 때의 음영 색상(`ambient`)을 더 어둡게 만들어, 빛을 받는 부분과의 대비를 명확하게 하여 그림자가 잘 보이도록 수정했습니다.

### 4. 최종 품질 개선
- **조명 설정:** 빛의 각도를 더 낮게 조정하여 그림자가 길고 뚜렷하게 보이도록 연출을 개선했습니다.
- **코드 안정성 강화:** 다른 AI의 제안을 검토 및 수용하여, 다음과 같은 개선 작업을 수행했습니다.
    1. `CalcPcfShadow` 함수에 그림자 좌표 범위를 체크하는 로직을 추가하여, 빛의 절두체 경계에서 발생할 수 있는 문제를 방지했습니다.
    2. 셰이더에 하드코딩되었던 그림자 맵 해상도(`2048`)를 C++에서 상수 버퍼로 전달하도록 수정하여, 향후 해상도 변경에 유연하게 대처할 수 있도록 코드 품질을 높였습니다.

위의 과정을 통해 모든 버그를 해결하고, 모든 객체가 정상적으로 그림자를 생성하며 지형과 다른 객체 위에 그림자가 올바르게 표시되는 안정적인 그림자 시스템을 구현 완료했습니다.